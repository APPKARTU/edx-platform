sudo: required

language: python
python:
  - "2.7"
services:
  # - mongodb
  # - mysql
  # - rabbitmq
  # - memcached
  - docker
  
env:
  - TEST_SUITE="quality"
  - TEST_SUITE="lms-unit"
    SHARD=1
  - TEST_SUITE="lms-unit"
    SHARD=2
  - TEST_SUITE="lms-unit"
    SHARD=3
  - TEST_SUITE="lms-unit"
    SHARD=4
  - TEST_SUITE="cms-unit"
  - TEST_SUITE="commonlib-unit"
  - TEST_SUITE="js-unit"
  - TEST_SUITE="lms-acceptance"
  - TEST_SUITE="cms-acceptance"
  - TEST_SUITE="bok-choy"
    SHARD=1
  - TEST_SUITE="bok-choy"
    SHARD=2
  - TEST_SUITE="bok-choy"
    SHARD=3
  - TEST_SUITE="bok-choy"
    SHARD=4
  - TEST_SUITE="bok-choy"
    SHARD=5
  - TEST_SUITE="bok-choy"
    SHARD=6
  - TEST_SUITE="bok-choy"
    SHARD=7
  - TEST_SUITE="bok-choy"
    SHARD=8
  - TEST_SUITE="bok-choy"
    SHARD=9
  - TEST_SUITE="bok-choy"
    SHARD=10
  - TEST_SUITE="bok-choy"
    SHARD=11

branches:
  only:
  - master
  - oxa/master.fic
  - oxa/dev.fic
  - oxa/ci
  - oxa/ci-docker
  
# before_script:
#   - "export PATH=$PATH:$PWD/node_modules/.bin"
#   - "export DISPLAY=:99.0"
#   - "sh -e /etc/init.d/xvfb start"
#   - sleep 3

before_install:
  - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
  - docker pull btelnes/devstack

install:
  - docker run -d --name devstack --security-opt seccomp=unconfined --tmpfs /run --tmpfs /run/lock -v /sys/fs/cgroup:/sys/fs/cgroup:ro -e TEST_SUITE="$TEST_SUITE" -e SHARD="$SHARD" -e CODE_COV_TOKEN="$CODE_COV_TOKEN" -t btelnes/devstack
  - docker --version  
  - docker ps -a
  
script: 
  # Fix an issue caused by /var/lib/mongodb/mongod.lock (Exception in initAndListen: 12596 old lock file)
  # - >
  #   docker exec -i devstack /bin/bash -s <<EOF
  #   echo 'Restarting Mongo'
  #   sudo -S rm /edx/var/mongo/mongodb/mongod.lock
  #   sudo -S mongod -repair --config /etc/mongod.conf
  #   sudo -S chown -R mongodb:mongodb /edx/var/mongo/.
  #   sudo -S service mongod start
  #   EOF
  - ./scripts/docker-run-tests.sh

after_success:
  - docker exec -i devstack /bin/bash -c "sudo su edxapp -s /bin/bash; source /edx/app/edxapp/edxapp_env; cd /edx/app/edxapp/edx-platform; export TRAVIS=true; pip install codecov==2.0.5; codecov"

addons:
  firefox: "45.0"
  chrome: stable

dist: trusty
